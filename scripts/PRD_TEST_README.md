# PRD生成功能自动化测试

## 概述

`test-prd-generation-auto.ts` 是一个全面的自动化测试脚本，用于测试PRD生成功能的所有方面，包括：

- ✅ PRD生成流程完整性
- ✅ 数据返回完整性
- ✅ 日志记录完整性
- ✅ 错误处理
- ✅ 澄清流程
- ✅ 继续对话功能

## 运行测试

### 方式1: 使用npm脚本（推荐）

```bash
npm run test:prd
```

### 方式2: 直接运行

```bash
tsx scripts/test-prd-generation-auto.ts
```

### 方式3: 使用tsx直接执行

```bash
./scripts/test-prd-generation-auto.ts
```

## 测试内容

### 1. 启动PRD生成（完整需求）
- 验证任务创建
- 验证需求保存
- 验证用户消息保存
- 验证返回的taskId有效性

### 2. 监控生成进度
- 实时监控任务进度
- 验证状态变化
- 验证完成状态

### 3. 验证任务状态返回完整性
- 验证必需字段存在
- 验证状态值有效性
- 验证进度值范围
- 验证时间戳字段

### 4. 验证对话消息完整性
- 验证消息结构
- 验证消息顺序
- 验证角色值有效性
- 验证内容不为空

### 5. 验证Schema完整性
- 验证Schema结构
- 验证产品概述
- 验证功能需求列表
- 验证功能需求结构

### 6. 验证PRD生成结果完整性
- 验证PRD内容存在
- 验证内容长度
- 验证内容完整性（产品概述、功能需求、非功能需求、用户场景）

### 7. 测试不完整需求的澄清流程
- 测试不完整需求处理
- 验证澄清问题生成
- 验证对话消息保存

### 8. 测试继续对话功能
- 测试用户回答保存
- 验证继续对话流程
- 验证消息更新

### 9. 验证错误处理
- 测试无效taskId处理
- 验证错误返回格式

## 测试报告

测试完成后会生成详细的测试报告，包括：

- 总测试数
- 通过/失败数量
- 通过率
- 每个测试的详细结果
- 执行时间

## 环境要求

1. 数据库已配置并运行
2. 环境变量已设置（API_KEY, BASE_URL等）
3. 已安装所有依赖

## 注意事项

- 测试可能需要较长时间（5-10分钟），因为需要等待AI生成完成
- 确保数据库连接正常
- 确保API服务可用
- 测试会创建实际的任务记录，建议在测试环境中运行

## 其他测试脚本

- `test-prd-generation-quick.ts` - 快速测试
- `test-prd-generation-complete.ts` - 完整测试（单个场景）
- `test-prd-generation-detailed.ts` - 详细测试
- `test-prd-full-flow.ts` - 完整流程测试（包含对话）

## 故障排查

如果测试失败，请检查：

1. 数据库连接是否正常
2. API服务是否运行
3. 环境变量是否正确设置
4. 查看测试报告中的详细错误信息
5. 检查日志输出

